// Generated by Copilot
// Content Extractor Tests - Simplified JSDOM-based approach

import { ContentExtractor } from '../../utils/content-extractor';

// Helper function to set up JSDOM with real HTML
const setupDOM = (html: string) => {
  // Set up the document with the provided HTML
  document.documentElement.innerHTML = html;
  
  // Mock window.location for consistent URL handling
  Object.defineProperty(window, 'location', {
    value: {
      href: 'https://example.com/test-article',
      hostname: 'example.com',
      pathname: '/test-article'
    },
    writable: true
  });

  // Ensure document.readyState is set
  Object.defineProperty(document, 'readyState', {
    value: 'complete',
    writable: true
  });
};

describe('ContentExtractor - Core Functionality', () => {
  let extractor: ContentExtractor;

  beforeEach(() => {
    extractor = new ContentExtractor();
    // Reset document content
    document.documentElement.innerHTML = '';
    jest.clearAllMocks();
  });

  describe('Content Identification', () => {
    test('C.1.1 - Extract main content from article pages', async () => {
      const articleHtml = `
        <head>
          <title>Test Article</title>
          <meta property="og:title" content="Test Article">
          <meta name="author" content="Test Author">
          <meta name="keywords" content="test, article, content">
        </head>
        <body>
          <nav>Navigation content</nav>
          <aside>Sidebar ads</aside>
          <article class="article-content" id="main-article">
            <h1>Main Article Title</h1>
            <p>This is the main article content that should be extracted.</p>
            <p>Another paragraph with valuable content.</p>
          </article>
          <footer>Footer content</footer>
        </body>
      `;

      setupDOM(articleHtml);

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.content).toContain('Main Article Title');
      expect(result.content).toContain('main article content');
      expect(result.metadata).toBeDefined();
      expect(result.metadata.title).toBe('Test Article');
      expect(result.metadata.author).toBe('Test Author');
      expect(result.wordCount).toBeGreaterThan(5);
    });

    test('C.1.2 - Extract content from blog posts', async () => {
      const blogHtml = `
        <head>
          <title>Blog Post Title</title>
        </head>
        <body>
          <header>Blog Header</header>
          <main>
            <div class="blog-content">
              <h1>How to Build Amazing Apps</h1>
              <div class="post-meta">By John Doe, Published: 2024-01-15</div>
              <p>Building amazing applications requires careful planning and execution.</p>
              <h2>Key Principles</h2>
              <ul>
                <li>User-centered design</li>
                <li>Performance optimization</li>
                <li>Scalable architecture</li>
              </ul>
            </div>
          </main>
        </body>
      `;

      setupDOM(blogHtml);

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.content).toContain('Build Amazing Apps');
      expect(result.content).toContain('careful planning');
      expect(result.wordCount).toBeGreaterThan(10);
      expect(result.readingTime).toBeGreaterThan(0);
    });

    test('C.1.3 - Handle pages with no clear main content', async () => {
      const genericHtml = `
        <head><title>Generic Page</title></head>
        <body>
          <div>
            <p>Some scattered content here with enough text to make it meaningful and pass minimum requirements.</p>
          </div>
          <div>
            <p>More scattered content there with additional meaningful text for testing purposes.</p>
          </div>
        </body>
      `;

      setupDOM(genericHtml);

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.content).toContain('scattered content');
      expect(result.content.length).toBeGreaterThan(0);
      expect(result.wordCount).toBeGreaterThan(0);
    });
  });

  describe('Content Quality Assessment', () => {
    test('C.4.1 - Calculate word count accurately', async () => {
      const contentHtml = `
        <head><title>Word Count Test</title></head>
        <body>
          <div class="content-text">
            <p>This is a test article with exactly twelve words in this sentence.</p>
          </div>
        </body>
      `;

      setupDOM(contentHtml);

      const result = await extractor.extractContent();

      expect(result.wordCount).toBe(12);
      expect(typeof result.wordCount).toBe('number');
    });

    test('C.4.2 - Estimate reading time', async () => {
      // Create content with approximately 300 words
      const longContent = 'This is a comprehensive article with substantial content that demonstrates proper reading time estimation. '.repeat(30);
      const contentHtml = `
        <head><title>Reading Time Test</title></head>
        <body>
          <div class="content-text">
            <p>${longContent}</p>
          </div>
        </body>
      `;

      setupDOM(contentHtml);

      const result = await extractor.extractContent();

      expect(result.readingTime).toBeGreaterThan(0);
      expect(result.readingTime).toBeLessThan(10);
      expect(typeof result.readingTime).toBe('number');
    });
  });

  describe('Metadata Extraction', () => {
    test('M.1.1 - Extract title from various sources', async () => {
      const htmlWithMetadata = `
        <head>
          <title>Document Title</title>
          <meta property="og:title" content="OpenGraph Title">
          <meta name="twitter:title" content="Twitter Title">
        </head>
        <body>
          <h1>Header Title</h1>
          <div class="entry-content">
            <p>Some content here with enough text to be meaningful for extraction purposes.</p>
          </div>
        </body>
      `;

      setupDOM(htmlWithMetadata);

      const result = await extractor.extractContent();

      // Should prefer og:title over document.title
      expect(result.metadata.title).toBe('OpenGraph Title');
      expect(result.metadata.url).toBe('https://example.com/test-article');
      expect(result.metadata.captureDate).toBeDefined();
    });

    test('M.1.2 - Extract author information', async () => {
      const htmlWithAuthor = `
        <head>
          <meta name="author" content="Jane Smith">
        </head>
        <body>
          <article>
            <h1>Article with Author</h1>
            <p>Content written by an identified author with sufficient text for proper extraction.</p>
          </article>
        </body>
      `;

      setupDOM(htmlWithAuthor);

      const result = await extractor.extractContent();

      expect(result.metadata.author).toBe('Jane Smith');
    });

    test('M.1.3 - Extract and process tags', async () => {
      const htmlWithTags = `
        <head>
          <meta name="keywords" content="javascript, typescript, testing">
        </head>
        <body>
          <div class="entry-content">
            <h1>Tagged Article</h1>
            <p>This article has tags and categories for organization purposes and content management.</p>
            <div class="tag">programming</div>
            <div class="category">web-development</div>
          </div>
        </body>
      `;

      setupDOM(htmlWithTags);

      const result = await extractor.extractContent();

      expect(result.metadata.tags).toContain('javascript');
      expect(result.metadata.tags).toContain('typescript');
      expect(result.metadata.tags).toContain('programming');
      expect(result.metadata.tags.length).toBeGreaterThan(0);
    });
  });

  describe('Utility Methods', () => {
    test('U.1.1 - Extract images with metadata', () => {
      const htmlWithImages = `
        <body>
          <img src="https://example.com/image1.jpg" alt="Test Image 1" title="Image Title">
          <img src="https://example.com/image2.png" alt="Test Image 2">
          <img src="data:image/gif;base64,..." alt="Base64 Image">
        </body>
      `;

      setupDOM(htmlWithImages);

      const images = extractor.extractImages();

      expect(images).toHaveLength(2); // Should exclude data: images
      expect(images[0]).toEqual({
        src: 'https://example.com/image1.jpg',
        alt: 'Test Image 1',
        title: 'Image Title'
      });
      expect(images[1]).toEqual({
        src: 'https://example.com/image2.png',
        alt: 'Test Image 2',
        title: ''
      });
    });

    test('U.1.2 - Extract links with metadata', () => {
      const htmlWithLinks = `
        <body>
          <a href="https://example.com/link1" title="Link Title">Link Text 1</a>
          <a href="https://example.com/link2">Link Text 2</a>
          <a href="javascript:void(0)">JavaScript Link</a>
        </body>
      `;

      setupDOM(htmlWithLinks);

      const links = extractor.extractLinks();

      expect(links).toHaveLength(2); // Should exclude javascript: links
      expect(links[0]).toEqual({
        href: 'https://example.com/link1',
        text: 'Link Text 1',
        title: 'Link Title'
      });
      expect(links[1]).toEqual({
        href: 'https://example.com/link2',
        text: 'Link Text 2',
        title: ''
      });
    });

    test('U.1.3 - Analyze page structure', () => {
      const htmlWithStructure = `
        <body>
          <h1>Main Heading</h1>
          <h2>Sub Heading 1</h2>
          <h3>Sub Heading 2</h3>
          <section>Section 1</section>
          <article>Article 1</article>
          <p>Paragraph 1</p>
          <p>Paragraph 2</p>
          <p>Paragraph 3</p>
        </body>
      `;

      setupDOM(htmlWithStructure);

      const structure = extractor.getPageStructure();

      expect(structure.headings).toHaveLength(3);
      expect(structure.headings).toContain('Main Heading');
      expect(structure.headings).toContain('Sub Heading 1');
      expect(structure.sections).toBe(2); // section + article
      expect(structure.paragraphs).toBe(3);
    });

    test('U.1.4 - Calculate content quality score', () => {
      const qualityHtml = `
        <body>
          <article>
            <h1>High Quality Article</h1>
            <h2>Introduction</h2>
            <p>This is a comprehensive article with substantial content that demonstrates high quality standards.</p>
            <p>It contains multiple paragraphs with meaningful information and proper structural organization.</p>
            <p>The content is well-organized and provides significant value to readers through detailed explanations.</p>
            <img src="https://example.com/diagram.jpg" alt="Helpful diagram">
            <h2>Main Content</h2>
            <p>Additional detailed content continues here with more valuable information for readers and comprehensive coverage.</p>
            <a href="https://example.com/reference">Relevant reference link</a>
          </article>
        </body>
      `;

      setupDOM(qualityHtml);

      const score = extractor.getContentQualityScore();

      expect(score).toBeGreaterThan(50); // Should be reasonably high quality
      expect(score).toBeLessThanOrEqual(100);
      expect(typeof score).toBe('number');
    });
  });

  describe('Edge Cases and Error Handling', () => {
    test('E.1.1 - Handle empty document', async () => {
      setupDOM('<body></body>');

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.content).toBeDefined();
      expect(result.wordCount).toBe(0);
      expect(result.readingTime).toBe(0);
    });

    test('E.1.2 - Handle malformed HTML', async () => {
      const malformedHtml = `
        <body>
          <div>
            <p>Content with unclosed tags and sufficient text for meaningful content extraction
            <span>Nested content without proper closing tags
            <p>More content without proper structural organization but enough text for testing</p>
          </div>
        </body>
      `;

      setupDOM(malformedHtml);

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.content).toContain('Content with unclosed');
      expect(result.wordCount).toBeGreaterThan(0);
    });

    test('E.1.3 - Handle content with only whitespace', async () => {
      const whitespaceHtml = `
        <body>
          <div class="content">
            <p>   </p>
            <div>
              
            </div>
            <span>	</span>
          </div>
        </body>
      `;

      setupDOM(whitespaceHtml);

      const result = await extractor.extractContent();

      expect(result).toBeDefined();
      expect(result.wordCount).toBe(0);
    });
  });
});
