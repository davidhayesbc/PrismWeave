// Generated by Copilot
// Unified File Manager Tests - Comprehensive test suite for file naming and folder detection
// Tests the metadata extraction and categorization logic

import { IDocumentMetadata } from '../../types/types.js';
import { FileManager } from '../../utils/file-manager.js';

describe('FileManager - Folder Detection and File Organization', () => {
  let fileManager: FileManager;

  beforeEach(() => {
    fileManager = new FileManager();
  });

  describe('Folder Detection (Domain-Based)', () => {
    test('should extract domain from URL as folder name', () => {
      const metadata: IDocumentMetadata = {
        title: 'Building Industrial Strength Software without Unit Tests',
        url: 'https://example.com/posts/software-development',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['programming', 'haskell', 'testing'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('example-com');
    });

    test('should extract domain from dev.to URL', () => {
      const metadata: IDocumentMetadata = {
        title: 'Advanced React Patterns and Best Practices',
        url: 'https://dev.to/react-patterns',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['javascript', 'react', 'frontend'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('dev-to');
    });

    test('should extract domain from GitHub URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'PrismWeave Documentation',
        url: 'https://github.com/user/project/readme',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['documentation'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('github-com');
    });

    test('should extract domain from StackOverflow URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'How to debug async/await in Node.js',
        url: 'https://stackoverflow.com/questions/debugging-nodejs',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('stackoverflow-com');
    });

    test('should extract domain from marketing URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'Digital Marketing Strategies for 2025',
        url: 'https://marketing.com/strategies',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['marketing', 'business', 'strategy'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('marketing-com');
    });

    test('should extract domain from LinkedIn URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'Leadership Insights from Fortune 500 CEOs',
        url: 'https://linkedin.com/posts/leadership-insights',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('linkedin-com');
    });

    test('should extract domain from tutorial URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'How to Build a REST API with Node.js - Step by Step Guide',
        url: 'https://tutorial.com/nodejs-api',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['tutorial', 'guide', 'how-to'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('tutorial-com');
    });

    test('should extract domain from news URLs', () => {
      const metadata: IDocumentMetadata = {
        title: 'Breaking: New AI Breakthrough Announced',
        url: 'https://news.com/ai-breakthrough',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['news', 'ai', 'announcement'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('news-com');
    });

    test('should handle subdomains', () => {
      const metadata: IDocumentMetadata = {
        title: 'Blog Post',
        url: 'https://blog.example.com/remote-work-analysis',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['blog', 'analysis', 'opinion'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('blog-example-com');
    });
  });

  describe('File Naming', () => {
    test('should generate proper filename from metadata', () => {
      const metadata: IDocumentMetadata = {
        title: 'Building Industrial Strength Software',
        url: 'https://example.com/article',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['programming'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filename = fileManager.generateFilename(metadata);
      expect(filename).toMatch(
        /^\d{4}-\d{2}-\d{2}-example-com-building-industrial-strength-software\.md$/
      );
    });

    test('should handle special characters in titles', () => {
      const metadata: IDocumentMetadata = {
        title: 'How to Use C++ & Python: A Guide!',
        url: 'https://dev.com/guide',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filename = fileManager.generateFilename(metadata);
      expect(filename).toMatch(/^\d{4}-\d{2}-\d{2}-dev-com-how-to-use-c-python-a-guide\.md$/);
    });

    test('should truncate long titles appropriately', () => {
      const metadata: IDocumentMetadata = {
        title:
          'This is a very long title that should be truncated because it exceeds the reasonable length limit for filenames',
        url: 'https://example.com/long-title',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filename = fileManager.generateFilename(metadata);
      expect(filename.length).toBeLessThan(100); // Should be reasonably short
      expect(filename).toMatch(
        /^\d{4}-\d{2}-\d{2}-example-com-this-is-a-very-long-title-that-should-be-truncated\.md$/
      );
    });
  });

  describe('File Path Generation', () => {
    test('should generate complete file path with correct folder', () => {
      const metadata: IDocumentMetadata = {
        title: 'JavaScript Best Practices',
        url: 'https://developer.mozilla.org/js-guide',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['javascript', 'programming'],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filePath = fileManager.generateFilePath(metadata);
      expect(filePath).toMatch(
        /^documents\/developer-mozilla-org\/\d{4}-\d{2}-\d{2}-developer-mozilla-org-javascript-best-practices\.md$/
      );
    });

    test('should use domain as folder', () => {
      const metadata: IDocumentMetadata = {
        title: 'Custom Content',
        url: 'https://example.com/custom-article',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filePath = fileManager.generateFilePath(metadata, {});
      expect(filePath).toMatch(
        /^documents\/example-com\/\d{4}-\d{2}-\d{2}-example-com-custom-content\.md$/
      );
    });

    test('should use domain-based folder for all documents', () => {
      const metadata: IDocumentMetadata = {
        title: 'Tutorial Article',
        url: 'https://github.com/user/repo',
        captureDate: '2025-07-03T12:00:00Z',
        tags: [],
        wordCount: 100,
        estimatedReadingTime: 2,
      };

      const filePath = fileManager.generateFilePath(metadata, {});
      expect(filePath).toMatch(
        /^documents\/github-com\/\d{4}-\d{2}-\d{2}-github-com-tutorial-article\.md$/
      );
    });
  });

  describe('Folder Keywords Management', () => {
    test('should use domain-based folder structure', () => {
      // Folder determination is now based on domain extraction
      // No longer using predefined folder keywords
      expect(fileManager).toBeDefined();

      const metadata: IDocumentMetadata = {
        title: 'Test',
        url: 'https://techblog.com/article',
        captureDate: new Date().toISOString(),
        tags: [],
      };
      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('techblog-com');
    });
  });

  describe('Real-world Test Cases', () => {
    test('should correctly determine domain-based folder for Simon Willison article', () => {
      const metadata: IDocumentMetadata = {
        title: "Here's how I use LLMs to help me write code",
        url: 'https://simonwillison.net/2025/Mar/11/using-llms-for-code/',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['ai-assisted-programming', 'llm', 'code'],
        wordCount: 4782,
        estimatedReadingTime: 24,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('simonwillison-net'); // Domain-based folder
    });

    test('should correctly determine domain-based folder for Nanonets article', () => {
      const metadata: IDocumentMetadata = {
        title: 'Nanonets OCR Advanced Document Understanding API',
        url: 'https://nanonets.com/research/nanonets-ocr-s/',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['ocr', 'ai', 'machine-learning', 'document-processing'],
        wordCount: 1500,
        estimatedReadingTime: 8,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('nanonets-com'); // Domain-based folder
    });

    test('should correctly determine domain-based folder for Unison article', () => {
      const metadata: IDocumentMetadata = {
        title: 'Building Industrial Strength Software without Unit Tests',
        url: 'https://chrispenner.ca/posts/transcript-tests',
        captureDate: '2025-07-03T12:00:00Z',
        tags: ['programming', 'haskell', 'unison', 'testing', 'transcript-tests'],
        wordCount: 2400,
        estimatedReadingTime: 12,
      };

      const folder = fileManager.determineFolder(metadata);
      expect(folder).toBe('chrispenner-ca'); // Domain-based folder
    });
  });
});
