# PrismWeave CLI Testing Guide

## Quick Start

### Windows
```bash
.\setup-tests.bat
```

### Linux/Mac
```bash
chmod +x setup-tests.sh
./setup-tests.sh
```

### Manual Setup
```bash
npm install
npm run build
npm test
```

## Test Suite Overview

The PrismWeave CLI has comprehensive test coverage with 130+ tests across 4 test files:

### Test Files
1. **config.test.ts** - Configuration management (25+ tests)
2. **file-manager.test.ts** - GitHub operations (35+ tests)
3. **markdown-converter.test.ts** - HTML to Markdown conversion (40+ tests)
4. **content-extraction.test.ts** - Web content extraction (30+ tests)

### Coverage Goals
- **Target**: 60% minimum for all metrics
- **Expected**: 70-90% depending on module complexity

## Running Tests

### All Tests
```bash
npm test
```

### Watch Mode (Development)
```bash
npm run test:watch
```

### With Coverage Report
```bash
npm run test:coverage
```

### Specific Test File
```bash
npm test -- config.test.ts
npm test -- file-manager.test.ts
npm test -- markdown-converter.test.ts
npm test -- content-extraction.test.ts
```

### Specific Test Suite
```bash
npm test -- -t "ConfigManager"
npm test -- -t "FileManager"
npm test -- -t "MarkdownConverterCore"
npm test -- -t "ContentExtractionCore"
```

## Test Structure

### Example Test File
```typescript
// Generated by Copilot
// Tests for MyModule

import { MyModule } from '../src/my-module.js';

describe('MyModule', () => {
  let instance: MyModule;

  beforeEach(() => {
    instance = new MyModule();
    jest.clearAllMocks();
  });

  describe('Feature Name', () => {
    test('should do something', () => {
      const result = instance.doSomething();
      expect(result).toBe(expectedValue);
    });

    test('should handle errors', () => {
      expect(() => instance.doSomething()).toThrow();
    });
  });
});
```

## Mocking Patterns

### Mock fetch API
```typescript
global.fetch = jest.fn();

const mockFetch = global.fetch as jest.MockedFunction<typeof fetch>;
mockFetch.mockResolvedValueOnce({
  ok: true,
  status: 200,
  json: async () => ({ data: 'value' }),
} as Response);
```

### Mock DOM with jsdom
```typescript
import { JSDOM } from 'jsdom';

function setupDOM(html: string): void {
  const dom = new JSDOM(html, {
    url: 'https://example.com/test',
    contentType: 'text/html',
  });
  global.document = dom.window.document as any;
  global.window = dom.window as any;
}

// Use in tests
setupDOM('<html><body><p>Content</p></body></html>');
```

### Mock File System
```typescript
import { existsSync, readFileSync, writeFileSync } from 'fs';

jest.mock('fs', () => ({
  existsSync: jest.fn(),
  readFileSync: jest.fn(),
  writeFileSync: jest.fn(),
  mkdirSync: jest.fn(),
  unlinkSync: jest.fn(),
}));

// Configure mock behavior
const mockReadFileSync = readFileSync as jest.MockedFunction<typeof readFileSync>;
mockReadFileSync.mockReturnValue('file content');
```

## Coverage Reports

### Viewing Reports
After running `npm run test:coverage`:
```bash
# Open HTML report
open cli/coverage/lcov-report/index.html  # Mac
start cli/coverage/lcov-report/index.html  # Windows
xdg-open cli/coverage/lcov-report/index.html  # Linux
```

### Understanding Coverage Metrics

- **Statements**: % of executable statements executed
- **Branches**: % of conditional branches taken
- **Functions**: % of functions called
- **Lines**: % of source lines executed

### Coverage Thresholds
All metrics must meet 60% minimum:
```json
{
  "coverageThreshold": {
    "global": {
      "branches": 60,
      "functions": 60,
      "lines": 60,
      "statements": 60
    }
  }
}
```

## Writing New Tests

### 1. Create Test File
```bash
touch tests/my-module.test.ts
```

### 2. Follow Naming Convention
- Test files: `*.test.ts`
- Match source file name: `my-module.ts` â†’ `my-module.test.ts`

### 3. Import Module with .js Extension
```typescript
import { MyModule } from '../src/my-module.js';
```

### 4. Organize with describe Blocks
```typescript
describe('MyModule', () => {
  describe('Feature Group', () => {
    test('should do specific thing', () => {
      // Test code
    });
  });
});
```

### 5. Use beforeEach for Setup
```typescript
let instance: MyModule;

beforeEach(() => {
  instance = new MyModule();
  jest.clearAllMocks();
});
```

### 6. Clean Up in afterEach
```typescript
afterEach(() => {
  jest.restoreAllMocks();
});
```

## Common Testing Scenarios

### Testing Async Functions
```typescript
test('should handle async operation', async () => {
  const result = await instance.asyncMethod();
  expect(result).toBeDefined();
});
```

### Testing Promises
```typescript
test('should resolve promise', () => {
  return expect(instance.promiseMethod()).resolves.toBe(value);
});

test('should reject promise', () => {
  return expect(instance.failingMethod()).rejects.toThrow();
});
```

### Testing Errors
```typescript
test('should throw error', () => {
  expect(() => instance.methodThatThrows()).toThrow('Error message');
});
```

### Testing with Timeouts
```typescript
test('should complete within timeout', async () => {
  await expect(instance.slowMethod()).resolves.toBeDefined();
}, 10000); // 10 second timeout
```

## Debugging Tests

### Run Single Test
```bash
npm test -- -t "specific test name"
```

### Run with Verbose Output
```bash
npm test -- --verbose
```

### Debug in VS Code
Add to `.vscode/launch.json`:
```json
{
  "type": "node",
  "request": "launch",
  "name": "Jest Debug",
  "program": "${workspaceFolder}/cli/node_modules/.bin/jest",
  "args": [
    "--runInBand",
    "--no-cache"
  ],
  "console": "integratedTerminal",
  "internalConsoleOptions": "neverOpen"
}
```

### Console Logging
```typescript
test('debug test', () => {
  console.log('Debug output:', someValue);
  expect(someValue).toBe(expected);
});
```

## Troubleshooting

### "Cannot find module" Error
- Ensure imports use `.js` extension
- Check `tsconfig.json` has correct module settings
- Verify file exists in expected location

### "SyntaxError: Unexpected token 'export'"
- Ensure `jest.config.js` has `extensionsToTreatAsEsm`
- Use `node --experimental-vm-modules` in test script
- Check `package.json` has `"type": "module"`

### Tests Pass Locally But Fail in CI
- Check Node.js version matches
- Verify all dependencies are installed
- Look for timing-dependent tests
- Check for file system path differences

### Mock Not Working
- Call `jest.clearAllMocks()` in `beforeEach`
- Ensure mock is defined before import
- Check mock function signature matches original

### Coverage Not Updating
- Clear Jest cache: `npm test -- --clearCache`
- Delete `coverage/` directory and regenerate
- Ensure test files are in correct location

## Best Practices

### 1. Test Behavior, Not Implementation
```typescript
// Good - tests behavior
test('should format date correctly', () => {
  expect(formatDate(date)).toMatch(/\d{4}-\d{2}-\d{2}/);
});

// Bad - tests implementation
test('should call formatDate helper', () => {
  const spy = jest.spyOn(helpers, 'formatDate');
  instance.method();
  expect(spy).toHaveBeenCalled();
});
```

### 2. Keep Tests Independent
```typescript
// Good - each test is independent
test('test 1', () => {
  const instance = new MyClass();
  expect(instance.value).toBe(0);
});

test('test 2', () => {
  const instance = new MyClass();
  expect(instance.value).toBe(0);
});
```

### 3. Use Descriptive Test Names
```typescript
// Good
test('should return empty array when no items match filter', () => {});

// Bad
test('test filter', () => {});
```

### 4. Test Edge Cases
```typescript
test('should handle empty string', () => {});
test('should handle null input', () => {});
test('should handle undefined', () => {});
test('should handle very large numbers', () => {});
```

### 5. Mock External Dependencies
```typescript
// Always mock:
// - Network requests (fetch, axios)
// - File system operations (fs)
// - Database calls
// - Third-party APIs
```

## CI/CD Integration

### GitHub Actions Example
```yaml
name: Test CLI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: cd cli && npm install
      - run: cd cli && npm test
      - run: cd cli && npm run test:coverage
```

## Additional Resources

- [Jest Documentation](https://jestjs.io/)
- [Testing Best Practices](https://github.com/goldbergyoni/javascript-testing-best-practices)
- [TypeScript Testing](https://www.typescriptlang.org/docs/handbook/testing.html)
- [Project Test README](tests/README.md)
- [Test Implementation Summary](TEST_IMPLEMENTATION_SUMMARY.md)

## Getting Help

If you encounter issues:
1. Check this guide first
2. Review existing test files for examples
3. Check Jest documentation
4. Review error messages carefully
5. Ask in project discussions
