# PrismWeave CLI Tests

This directory contains comprehensive test suites for the PrismWeave CLI tool.

## Test Coverage

### `config.test.ts`
Tests for the ConfigManager class that handles CLI configuration:
- Configuration loading and persistence
- Get/set operations for config values
- Configuration validation
- File system operations
- Type safety and edge cases

### `file-manager.test.ts`
Tests for the FileManager class that handles GitHub operations:
- Filename generation and sanitization
- Folder classification based on content
- File path generation
- GitHub API integration (save, update, test connection)
- PDF file handling
- Repository path parsing
- Commit message generation

### `markdown-converter.test.ts`
Tests for the MarkdownConverterCore class:
- Basic HTML to Markdown conversion
- Complex HTML structures (lists, code blocks, blockquotes)
- Conversion options (images, links, formatting)
- Statistics calculation (word count, image count, link count)
- Special characters and HTML entities
- Custom rules (strikethrough, task lists)
- Whitespace handling
- Real-world HTML structures
- Performance with large content

### `content-extraction.test.ts`
Tests for the ContentExtractionCore class:
- Metadata extraction (title, description, author, keywords)
- Image extraction and URL normalization
- Page structure analysis
- Content quality scoring
- Paywall detection
- Advanced metadata (Open Graph, Twitter Cards, JSON-LD)
- Blog post detection
- Edge cases and error handling

## Running Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage report
npm run test:coverage
```

## Test Environment

- **Framework**: Jest 29.x with TypeScript support
- **DOM Simulation**: jsdom for browser environment simulation
- **Module System**: ES Modules (ES2022)
- **Coverage Threshold**: 60% for all metrics (branches, functions, lines, statements)

## Writing New Tests

1. Create a new test file in the `tests/` directory with `.test.ts` extension
2. Import the module to test
3. Use Jest's `describe` and `test` blocks to organize tests
4. Mock external dependencies (fetch, file system, etc.)
5. Follow the existing patterns for consistency

### Example Test Structure

```typescript
// Generated by Copilot
// Tests for MyModule

import { MyModule } from '../src/my-module.js';

describe('MyModule', () => {
  let instance: MyModule;

  beforeEach(() => {
    instance = new MyModule();
    jest.clearAllMocks();
  });

  describe('Feature Name', () => {
    test('should do something', () => {
      const result = instance.doSomething();
      expect(result).toBe(expectedValue);
    });
  });
});
```

## Mocking Best Practices

### Mocking fetch
```typescript
global.fetch = jest.fn();

const mockFetch = global.fetch as jest.MockedFunction<typeof fetch>;
mockFetch.mockResolvedValueOnce({
  ok: true,
  json: async () => ({ data: 'value' }),
} as Response);
```

### Mocking DOM
```typescript
import { JSDOM } from 'jsdom';

function setupDOM(html: string): void {
  const dom = new JSDOM(html, { url: 'https://example.com' });
  global.document = dom.window.document as any;
  global.window = dom.window as any;
}
```

### Mocking File System
```typescript
import { existsSync, readFileSync, writeFileSync } from 'fs';

jest.mock('fs', () => ({
  existsSync: jest.fn(),
  readFileSync: jest.fn(),
  writeFileSync: jest.fn(),
}));
```

## Coverage Reports

Coverage reports are generated in the `coverage/` directory:
- `coverage/lcov-report/index.html` - Interactive HTML report
- `coverage/lcov.info` - LCOV format for CI/CD integration
- Console output shows summary after test run

## Continuous Integration

These tests are designed to run in CI/CD pipelines:
- All tests must pass before merging
- Coverage thresholds must be met
- Tests run on Node.js 20.x+

## Troubleshooting

### ES Module Issues
If you encounter module resolution errors, ensure:
- All imports use `.js` extension
- `package.json` has `"type": "module"`
- Jest config uses `extensionsToTreatAsEsm`

### TypeScript Compilation
Tests are compiled on-the-fly by ts-jest. If compilation fails:
- Check `tsconfig.json` settings
- Verify all dependencies are installed
- Run `npm run build` to check for TypeScript errors

### Mock Not Working
If mocks aren't being applied:
- Clear mocks in `beforeEach` with `jest.clearAllMocks()`
- Ensure mocks are defined before importing modules
- Check mock implementation matches expected interface
